<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>WebTorrent P2P Share + Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>

<style>
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
  padding:14px;
  max-width:720px;
  margin:auto;
  background:#fafafa;
}
h2{font-size:1.4em}
input,button{
  width:100%;
  padding:14px;
  margin:8px 0;
  font-size:1em;
  border-radius:10px;
}
input{border:1px solid #ccc}
button{border:none;font-weight:600;cursor:pointer}
.btn-seed{background:#4CAF50;color:#fff}
.btn-copy{background:#2196F3;color:#fff}
.btn-download{background:#FF9800;color:#fff}
button:disabled{background:#aaa}

.status,.stats{
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}
.status{background:#e3f2fd}
.stats{background:#f1f8e9;font-size:.9em}
.stats div{margin:4px 0}

pre{
  background:#111;color:#0f0;
  padding:10px;border-radius:10px;
  height:180px;overflow:auto;font-size:12px;
}

.chat-box{
  background:#000;color:#0f0;
  padding:8px;border-radius:8px;
  height:140px;overflow:auto;font-size:12px;
}
.footer{text-align:center;font-size:.8em;color:#666;margin-top:10px}
</style>
</head>

<body>
<h2>ğŸ“¤ WebTorrent P2P Share + Chat</h2>

<div class="status">
Upload â†’ Seed â†’ Share Magnet â†’ Download â†’ <b>Ikut Seeding</b>
</div>

<input type="file" id="fileInput">
<button class="btn-seed" onclick="seedFile()">ğŸŒ± Mulai Seeding</button>

<input id="magnet" placeholder="Magnet URI">

<button class="btn-copy" id="copyBtn" onclick="copyMagnet()" disabled>ğŸ“‹ Salin Magnet</button>
<button class="btn-download" onclick="download()">â¬‡ï¸ Download</button>

<div id="info" class="status">â„¹ï¸ Belum ada aktivitas</div>

<div class="stats">
<b>ğŸ“Š Status Torrent</b>
<div>ğŸŸ¢ Mode: <span id="seedStatus">Tidak aktif</span></div>
<div>ğŸ‘¥ Peer: <span id="peerCount">0</span></div>
<div>ğŸ“¦ File: <span id="fileCount">0</span></div>
<div>â¬†ï¸ Upload total: <span id="uploaded">0 B</span></div>
<div>âš¡ Upload speed: <span id="upSpeed">0 B/s</span></div>
</div>

<pre id="log"></pre>

<div class="stats">
<b>ğŸ’¬ P2P Chat</b>
<div id="chatBox" class="chat-box"></div>
<input id="chatInput" placeholder="Ketik pesan..." disabled>
<button onclick="sendChat()" id="chatSend" disabled>ğŸ“¨ Kirim</button>
</div>

<div class="footer">
Selama tab terbuka, kamu adalah seeder ğŸŒ±
</div>

<script>
const client = new WebTorrent();
let currentTorrent = null;
let uploadedBytes = 0;
let chatWires = [];

const peerName = "Peer-" + Math.random().toString(36).slice(2,6);

const log = m=>{
  const p=document.getElementById("log");
  p.textContent+=`[${new Date().toLocaleTimeString()}] ${m}\n`;
  p.scrollTop=p.scrollHeight;
};

const format=b=>{
  if(b>1024*1024)return (b/1024/1024).toFixed(2)+" MB";
  if(b>1024)return (b/1024).toFixed(1)+" KB";
  return b+" B";
};

const addChat=m=>{
  const box=document.getElementById("chatBox");
  box.innerHTML+=m+"<br>";
  box.scrollTop=box.scrollHeight;
};

// ================= CHAT =================
function sendChat(){
  const input=document.getElementById("chatInput");
  const text=input.value.trim();
  if(!text)return;

  const payload=JSON.stringify({from:peerName,text});
  chatWires.forEach(w=>{
    try{ w.extended("chat",payload); }catch(e){}
  });

  addChat(`<b>${peerName}</b>: ${text}`);
  input.value="";
}

// ================= COPY =================
function copyMagnet(){
  navigator.clipboard.writeText(magnet.value);
  log("ğŸ“‹ Magnet disalin");
}

// ================= SEED =================
function seedFile(){
  if(!fileInput.files.length) return alert("Pilih file");
  client.seed(fileInput.files[0],torrent=>{
    currentTorrent=torrent;
    magnet.value=torrent.magnetURI;
    copyBtn.disabled=false;

    seedStatus.textContent="AKTIF (Seeder)";
    fileCount.textContent=torrent.files.length;

    log("ğŸŒ± Seeding dimulai");
    bindCommon(torrent,true);
  });
}

// ================= DOWNLOAD =================
function download(){
  if(!magnet.value.trim()) return alert("Paste magnet");
  client.add(magnet.value.trim(),torrent=>{
    currentTorrent=torrent;
    log("â¬‡ï¸ Download dimulai");

    torrent.on("download",()=>{
      info.textContent=`â¬‡ï¸ Download ${Math.round(torrent.progress*100)}%`;
    });

    torrent.on("done",()=>{
      seedStatus.textContent="AKTIF (Seeder)";
      fileCount.textContent=torrent.files.length;
      info.textContent="ğŸŒ± Download selesai Â· Ikut seeding";
      log("âœ… Download selesai");
      bindCommon(torrent,true);
    });
  });
}

// ================= COMMON =================
function bindCommon(torrent,enableUpload){
  torrent.on("wire",wire=>{
    log("ğŸ”— Peer terhubung");
    chatWires.push(wire);

    wire.use({
      name:"chat",
      onMessage:data=>{
        try{
          const m=JSON.parse(data.toString());
          addChat(`<b>${m.from}</b>: ${m.text}`);
        }catch(e){}
      }
    });

    chatInput.disabled=false;
    chatSend.disabled=false;
  });

  if(enableUpload){
    torrent.on("upload",b=>{
      uploadedBytes+=b;
      uploaded.textContent=format(uploadedBytes);
      upSpeed.textContent=format(torrent.uploadSpeed)+"/s";
    });
  }
}

// refresh peer count
setInterval(()=>{
  if(currentTorrent){
    peerCount.textContent=currentTorrent.numPeers;
  }
},1000);
</script>
</body>
</html>
